# SSA_PCOM7E | DEVELOPMENT TEAM PROJECT - CODE DEVELOPMENT

----

## <ins>Prerequisite</ins>
The following should be installed already before setup.
- Python3 ([Download](https://www.python.org/) 3.6 or later.)

## <ins>Requirements</ins>
```
pip install -r requirements.txt
```
## <ins>Programs</ins>
***Running in Linux or Windows from the downloaded directory.***

1.	Run the server.py (server) file to begin:
```
python3 /PATH/server.py
```
2.	Authenticate to the server, entering the password stored in readpwd.txt file.  Python checks the contents of this file when authenticating the user.
      a.	If the incorrect password is entered, the program displays a message and terminates cleanly
      b.	If the correct password is entered, the server:
      i.	authenticates the user
      ii.	connects to the broker (broker.emqx.io)
      iii.	pulls down the last message that the broker had stored, sent to it by the smart meter before disconnection, and displays it.  This is possible as the smart meter sends its messages with the retain flag set to True and all messages being sent with QoS 1.  Note that it also provides a calculation to pounds sterling to make it easier for the user to track expenditure.
      iv.	The server then sends a confirmation of this figure to the smart meter using topic UNIT1222, waits and listens for more messages.

3.	To begin sending more data to the server, run the smart_meter.py file:
```
python3 /PATH/smart_meter.py
```
4. Once open, the smart meter:
      a.	Connects to the broker
      b.	Pulls the last confirmation message from the broker that was sent from the server and displays it both in organic encrypted payload form, and in decrypted human-readable form
      c.	immediately begins transmitting (simulated energy usage) data using topic UNIT1221.  It does this by generating a random number and adding it to the current running total received from the server in the previous step
      d.	This data is sent to the broker, ready for the server to retrieve and repeat the process, starting at 2.b.iii again, setting the sequence in a continuous loop
5. To end the program, press Enter on the server screen
      
All messages are encrypted before being sent using a pre-shared key generated by fernet and inserted into both device scripts to enable encryption and decryption at both ends.  This ensures the broker never knows the value of the plain text.  It also means that it is impossible for the communications to be a victim of eavesdropping attacks due to the encryption key only being known by the server and the smart meter. 

Payload encryption is necessary due to the fact a public broker is used.  If a private broker was available, then PKI would have been a better method to protect the data in transit using port 8883 and certificates.  However, this is impossible due to the broker not being accessible.  This is also a limitation for authenticating to the broker, and so authentication has been placed on the front end instead.  

Some advantages however, are that PKI would also add to a greater overhead in terms of packet size, and battery life will consequently be reduced.  Additionally, by implementing authentication locally means that credentials are not sent over untrusted public communication.

QOS is set to 1, this guarantees that all packets are sent (at least once).  The fact that they are sent at least once is of no concern due to the retain flag only keeping the LAST message.  Therefore, QOS level 2 would have meant unnecessary overhead.  If QOS was set to 0, then the application may lose messages and therefore an unwanted incorrect reading may be given.

The retain flag is not set for the confirmation communication from the server on topic UNIT1222 as it is important that the smart meter controls the running total alone on UNIT1221, this guarantees the loop is unidirectional.

If the server gets disconnected, the smart_meter.py will wait until it is back up.  

The transmission loop will also be paused if the smart meter is disconnected.  However, following reconnection, the server will need to be rebooted as the communications loop starts when the server launches and picks up the last stored message on topic UNITS1221 from the broker.

Because the smart meter waits for the server, it is inconsequential in which order the devices are booted to begin the program again.

Decrypted meter output will be displayed:
```
Total Units =  42
Total Cost (@£0.00039 per unit): £ 0.0164
message topic= UNITS1221
message qos= 1
message retain flag= 0
cipher =  <cryptography.fernet.Fernet object at 0x104c554b0>
message =  <paho.mqtt.client.MQTTMessage object at 0x1048ff220>
message payload =  b'gAAAAABjJh-ggjEprmISiulhyDIVqwRIgHJnSjdNsIdv_rCJ4rUWOWNYdKSV3IHB3GuWZ__PA0HtlS5aKMwbvmcSnFBiNes1-w=='

Total Units =  48
Total Cost (@£0.00039 per unit): £ 0.0187
message topic= UNITS1221
message qos= 1
message retain flag= 0
cipher =  <cryptography.fernet.Fernet object at 0x104c55540>
message =  <paho.mqtt.client.MQTTMessage object at 0x1048ff220>
message payload =  b'gAAAAABjJh-iO1LtsJEIiRjizOdHGQvvjRlFwRegtOcY4BX7oGT6q5-Ir5HtHt60W4Wy16Qr3O-46_0L-hyfYhHUDZD32A3HYQ=='

Total Units =  48
Total Cost (@£0.00039 per unit): £ 0.0187
message topic= UNITS1221
message qos= 1
message retain flag= 0
cipher =  <cryptography.fernet.Fernet object at 0x104c555d0>
message =  <paho.mqtt.client.MQTTMessage object at 0x1048ff220>
message payload =  b'gAAAAABjJh-kBWxOWLFy3DZezipMXjHoGF0IvfvwabG7JD66KQusZ3Y0UzeFtlW9qbCvVW40ZbQO2LvVjsgk8BcIj2r6fUf2aA=='

Total Units =  52
Total Cost (@£0.00039 per unit): £ 0.0203
message topic= UNITS1221
message qos= 1
message retain flag= 0
```

## <ins>Private Broker Program</ins>

***For users with private broker setup (e.g. Eclipse Mosquito)***

Client connect anonymously without TLS
```
mosquitto_sub -t test/topic -h <broker address>
```
Client connect with username and no password without TLS
```
mosquitto_sub -t test/topic -u <username> -h <broker address>
```
Client connect with username and password without TLS
```
mosquitto_sub -t test/topic -u <username> -P <password> -h <broker address>
```
Subscribe to the $SYS topic and see information about the broker
```
mosquitto_sub -t '$SYS/#' -v -h <broker address>
```
Client connect using TLS
```
mosquitto_sub -t test/topic -h <broker address> -p 8883 --capath /etc/ssl/certs
```
Client subscribes to all topics
```
mosquitto_sub -t '#' -v
```
*Repeat all the above when publishing as well.*